@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@using System.Globalization
@{
    var currentCulture = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName; // "vi" or "en"
}


@* HEADER - HubCinema (Bootstrap 5.3.2 Responsive) *@
@{
    // Ưu tiên ViewBag nếu có, fallback cookie nếu không
    var inBookingFlow = ViewBag.inBookingFlow is bool vb ? vb : (Context.Request.Cookies["booking_flow"] == "1");
    var token = Context.Session.GetString("AccessToken");
    bool isLoggedIn = !string.IsNullOrEmpty(token);
}

@if (inBookingFlow)
{
    <div class="booking-header d-flex justify-content-between align-items-center px-4 py-3 bg-white border-bottom shadow-sm">
        <a href="/" class="navbar-brand">
            <img src="/images/hub_logo_new.png" alt="Logo" class="logo-hub" style="height: 42px;" />
        </a>
        <button class="btn btn-link text-danger fw-bold text-decoration-none" onclick="cancelBookingFlow()" style="font-size: 1rem;">
            Hủy giao dịch <i class="bi bi-x-lg ms-1"></i>
        </button>
    </div>

}
else
{
    <!-- Topbar -->
    <div class="bg-dark text-white py-2 px-4 d-flex justify-content-end align-items-center gap-3">
        <!-- Language switch -->
        <div class="language-switch border rounded-pill overflow-hidden d-flex">
            <button type="button" class="btn btn-sm lang-btn @(currentCulture == "vi" ? "active" : "")" data-lang="vi">VN</button>
            <button type="button" class="btn btn-sm lang-btn @(currentCulture == "en" ? "active" : "")" data-lang="en">EN</button>
        </div>

        <!-- Hidden form for language switch -->
        <form id="lang-form" asp-controller="Home" asp-action="SetLanguage" method="post" style="display: none;">
            <input type="hidden" name="culture" id="culture-input" />
            <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
        </form>

        <!-- Register -->
        @if (!isLoggedIn)
        {
            <a href="javascript:void(0);" onclick="openRegisterModal()" class="btn btn-sm btn-register">@Localizer["Register"]</a>
        }
    </div>


    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-white">
        <div class="container-fluid">
            <!-- Logo bên trái -->
            <a class="navbar-brand ms-lg-5 me-4" href="/">
                <img src="~/images/hub_logo_new.png" alt="Logo" class="logo-hub">
            </a>

            <!-- Toggler cho mobile -->
            <button class="navbar-toggler d-lg-none" type="button" id="menuToggle">
                <i class="bi bi-list fs-3"></i>
            </button>


            <!-- Trung tâm: TICKET + Nav Items -->
            <div class="collapse navbar-collapse justify-content-center d-none d-lg-flex" id="navbarNav">

                <ul class="navbar-nav align-items-center gap-lg-4">
                    <!-- TICKET button -->
                    <li class="nav-item">
                        <a asp-controller="Booking" asp-action="Index" class="btn-ticket d-none d-lg-block">
                            <img src="~/images/ticket-button.png" alt="TICKET" style="height: 50px;">
                        </a>
                    </li>

                    <!-- Menu dropdowns -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold" href="#" role="button" data-bs-toggle="dropdown">@Localizer["Movies"]</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/#showing">@Localizer["NowShowing"]</a></li>
                            <li><a class="dropdown-item" href="/#upcoming">@Localizer["ComingSoon"]</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold" href="#" role="button" data-bs-toggle="dropdown">@Localizer["Cinemas"]</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" asp-controller="Cinema" asp-action="GetAllCinemas">@Localizer["AllCinemas"]</a></li>
                            <li><a class="dropdown-item" asp-controller="Cinema" asp-action="GetCinema" asp-route-id="1">Galaxy Trung Chánh</a></li>
                            <li><a class="dropdown-item" asp-controller="Cinema" asp-action="GetCinema" asp-route-id="2">Galaxy Nguyễn Văn Quá</a></li>
                            <li><a class="dropdown-item" asp-controller="Cinema" asp-action="GetCinema" asp-route-id="3">Galaxy Nguyễn Du</a></li>
                            <li><a class="dropdown-item" asp-controller="Cinema" asp-action="GetCinema" asp-route-id="4">Galaxy Kinh Dương Vương</a></li>
                            <li><a class="dropdown-item" asp-controller="Cinema" asp-action="GetCinema" asp-route-id="5">Galaxy Kinh Đà Nẵng</a></li>
                            <li><a class="dropdown-item" asp-controller="Cinema" asp-action="GetCinema" asp-route-id="6">Galaxy Kinh Bến Tre</a></li>
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold" href="#" role="button" data-bs-toggle="dropdown">@Localizer["Products"]</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="@Url.Action("ListFood", "Food")">@Localizer["Snacks"]</a></li>
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold" href="#" role="button" data-bs-toggle="dropdown">@Localizer["News"]</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="@Url.Action("promotion", "Home")">@Localizer["Promotions"]</a></li>
                            <li><a class="dropdown-item" href="@Url.Action("ReviewMovies", "Home")">@Localizer["Reviews"]</a></li>
                        </ul>
                    </li>
                </ul>
            </div>

            <!-- Góc phải: Đăng nhập / Thành viên -->
            <div class="d-flex align-items-center gap-3 me-lg-5" style="margin-left: auto;">
                @if (!isLoggedIn)
                {
                    <a href="javascript:void(0);" onclick="openLoginModal()" class="d-flex align-items-center text-decoration-none text-dark">
                        <i class="bi bi-box-arrow-in-right"></i> <span class="ms-1">@Localizer["Login"]</span>
                    </a>
                }
                else
                {
                    <a asp-controller="Account" asp-action="Profile" class="d-flex align-items-center text-decoration-none text-dark">
                        <img src="~/images/member.png" class="me-1" style="width: 20px; height: 20px; object-fit: contain;" alt="Thành viên" />
                        <span>@Localizer["Membership"]</span>
                    </a>
                    <form asp-controller="Account" asp-action="Logout" method="post">
                        <button class="btn btn-sm btn-outline-dark" type="submit">@Localizer["Logout"]</button>
                    </form>
                }
            </div>
    </nav>

    <!-- Sidebar menu cho mobile -->
    <div id="mobileMenu" class="position-fixed top-0 end-0 bg-white shadow h-100 p-4" style="width: 280px; z-index: 1050; transform: translateX(100%); transition: transform 0.3s;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <img src="~/images/hub_logo_new.png" alt="Logo" height="28" />
            <button class="btn-close" id="menuClose"></button>
        </div>

        <a href="/dat-ve" class="btn btn-warning w-100 mb-3">
            <i class="bi bi-star-fill me-1"></i> @Localizer["BuyTickets"]</a>

        <div class="accordion" id="accordionMenu">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#menu1">@Localizer["Movies"]</button>
                </h2>
                <div id="menu1" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <a href="#" class="d-block">@Localizer["NowShowing"]</a>
                        <a href="#" class="d-block">@Localizer["ComingSoon"]</a>
                    </div>
                </div>
            </div>

            <!-- Bạn có thể lặp lại các mục giống như phần navbar -->
            <!-- Rạp -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#menuRap">
                        @Localizer["Cinemas"]
                    </button>
                </h2>
                <div id="menuRap" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <a href="#" class="d-block py-1">@Localizer["AllCinemas"]</a>
                        <a asp-controller="Cinema" asp-action="GetCinema" asp-route-id="1" class="d-block py-1">Galaxy Trung Chánh</a>
                        <a asp-controller="Cinema" asp-action="GetCinema" asp-route-id="2" class="d-block py-1">Galaxy Nguyễn Văn Quá</a>
                        <a asp-controller="Cinema" asp-action="GetCinema" asp-route-id="3" class="d-block py-1">Galaxy Nguyễn Du</a>
                        <a asp-controller="Cinema" asp-action="GetCinema" asp-route-id="4" class="d-block py-1">Galaxy Kinh Dương Vương</a>
                        <a asp-controller="Cinema" asp-action="GetCinema" asp-route-id="5" class="d-block py-1">Galaxy Đà Nẵng</a>
                        <a asp-controller="Cinema" asp-action="GetCinema" asp-route-id="6" class="d-block py-1">Galaxy Kinh Bến Tre</a>
                    </div>

                </div>
            </div>
            <!-- ... các mục khác -->
            <!-- Sản phẩm -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#menuSanPham">
                        @Localizer["Products"]
                    </button>
                </h2>
                <div id="menuSanPham" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <a href="@Url.Action("ListFood", "Food")">@Localizer["Snacks"]</a>
                    </div>
                </div>
            </div>

            <!-- Sự kiện và ưu đãi -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#menuSuKien">
                        @Localizer["Events"]
                    </button>
                </h2>
                <div id="menuSuKien" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <a href="@Url.Action("promotion", "Home")">@Localizer["Promotions"]</a>
                    </div>
                </div>
            </div>


        </div>

        <!-- Đăng nhập -->
        <div class="mt-4">
            @if (!isLoggedIn)
            {
                <a href="javascript:void(0);" onclick="openLoginModal()" class="d-block text-dark fw-medium mb-2">
                    <i class="bi bi-box-arrow-in-right"></i> @Localizer["Login"]
                </a>
                <a href="javascript:void(0);" onclick="openRegisterModal()" class="d-block text-dark fw-medium">
                    <i class="bi bi-person-plus"></i> @Localizer["Register"]
                </a>
            }
            else
            {
                <a asp-controller="Account" asp-action="Profile" class="d-block text-dark fw-medium mb-2">
                    <i class="bi bi-person-circle"></i> @Localizer["Membership"]
                </a>
                <form asp-controller="Account" asp-action="Logout" method="post">
                    <button type="submit" class="btn btn-sm btn-outline-dark w-100">@Localizer["Logout"]</button>
                </form>
            }
        </div>
    </div>
}

<script>
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const culture = btn.getAttribute('data-lang');
            document.getElementById('culture-input').value = culture;
            document.getElementById('lang-form').submit();
        });
    });
    function cancelBookingFlow() {
        if (confirm("Bạn có chắc chắn muốn hủy giao dịch này không?")) {
            sessionStorage.clear();
            document.cookie = "booking_flow=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            fetch("/Booking/CancelFlow") // cần có controller như đã nói
                .then(() => window.location.href = "/");
        }
    }
</script>




